module.exports=function($pending_plugins,$get_plugin){$pending_plugins.set('steel',()=>{let plugin={metadata:{"name":"steel","version":"0.1.0","description":"a game engine written in neutrino","main":"index.nt","author":"12Thanjo","dependancies":["BABYLON","DOM","OCS"]}};let BABYLON=$get_plugin('BABYLON');let DOM=$get_plugin('DOM');let {Prop,all,some,none}=$get_plugin('OCS');let OCS=$get_plugin('OCS');let Engine=function(name,config){let $this=this;let private={};this.$op={};Engine.$map.set(name,this);private.name=name;Object.defineProperty(this, "name", {get: ()=>{return private.name;}});let self=$this;if(config==null){config={};};if(config.canvas==null){$this.canvas=DOM.createElement("canvas",document.body);$this.canvas.css({width:DOM.w,height:DOM.h});}else{$this.canvas=DOM(config.canvas);};if(config.fov==null){config.fov=75;};if(config.shadowResolution==null){config.shadowResolution=2048;};if(config.MSAA==null){config.MSAA=1;};if(config.poll==null){config.poll=15.625;};if(config.create==null){config.create=()=>{};};if(config.update==null){config.update=()=>{};};if(config.render==null){config.render=()=>{};};private.engine=new BABYLON.Engine($this.canvas.array[0].element,true,{preserveDrawingBuffer:true,stencil:true,disableWebGL2Support:false});private.scene=new BABYLON.Scene(private.engine);private.camera=new BABYLON.FreeCamera("camera1",new BABYLON.Vector3(0,5,-10),private.scene);Object.defineProperty(this, "camera", {get: ()=>{return private.camera;}});private.camera.setTarget(BABYLON.Vector3.Zero());private.camera.fov=config.fov*0.0174;private.camera.minZ=0.1;private.scene.clearColor=new BABYLON.Color3(0.05,0.05,0.06);let light=new BABYLON.DirectionalLight("ambient light",new BABYLON.Vector3(-1,-2,-1),private.scene);;light.position=new BABYLON.Vector3(20,40,20);light.intensity=0.6;private.shadowGenerator=new BABYLON.ShadowGenerator(config.shadowResolution,light);private.shadowGenerator.setDarkness(0.25);private.shadowGenerator.usePoissonSampling=true;let sphere=BABYLON.MeshBuilder.CreateSphere("sphere",{diameter:2,segments:512},private.scene);;sphere.position.y=1;private.shadowGenerator.getShadowMap().renderList.push(sphere);sphere.receiveShadows=true;sphere.material=new BABYLON.StandardMaterial("mat",private.scene);sphere.material.diffuseColor=new BABYLON.Color3(0,0.8,1);sphere.material.emissiveColor=new BABYLON.Color3(0,0.16,0.2);let new_box=new BABYLON.Mesh.CreateBox("box",1,private.scene);;new_box.scaling.set(5,1,5);new_box.position.y=-1;private.shadowGenerator.getShadowMap().renderList.push(new_box);new_box.receiveShadows=true;let pipeline=new BABYLON.DefaultRenderingPipeline("default",true,private.scene,[private.camera]);;pipeline.fxaaEnabled=false;pipeline.samples=1;pipeline.sharpenEnabled=false;pipeline.sharpen.edgeAmount=1.2;pipeline.sharpen.colorAmount=1;pipeline.depthOfFieldEnabled=false;pipeline.depthOfFieldBlurLevel=1;pipeline.depthOfField.focusDistance=2000;pipeline.depthOfField.focalLength=50;pipeline.depthOfField.fStop=1.4;pipeline.bloomEnabled=false;pipeline.bloomKernel=200;pipeline.bloomWeight=0.8;pipeline.bloomThreshold=0.2;pipeline.bloomScale=0.7;let curve=new BABYLON.ColorCurves();;curve.globalHue=200;curve.globalDensity=80;curve.globalSaturation=80;curve.highlightsHue=20;curve.highlightsDensity=80;curve.highlightsSaturation=-80;curve.shadowsHue=2;curve.shadowsDensity=80;curve.shadowsSaturation=40;pipeline.imageProcessing.colorCurves=curve;pipeline.imageProcessing.colorCurvesEnabled=false;pipeline.imageProcessing.toneMappingEnabled=false;pipeline.imageProcessing.contrast=2;pipeline.imageProcessing.exposure=2;pipeline.imageProcessing.vignetteEnabled=true;pipeline.imageProcessing.vignetteColor=new BABYLON.Color3(0,0,0);pipeline.imageProcessing.vignetteWeight=2;pipeline.grainEnabled=false;pipeline.grain.intensity=40;pipeline.grain.animated=true;$this.pipeline={};Object.defineProperty($this.pipeline,'FXAA',{get:function(){return pipeline.fxaaEnabled;},set:function(val){pipeline.fxaaEnabled=val;}});Object.defineProperty($this.pipeline,'MSAA',{get:function(){return pipeline.samples;},set:function(val){pipeline.samples=val;}});$this.pipeline.sharpening={};Object.defineProperty($this.pipeline.sharpening,'enabled',{get:function(){return pipeline.sharpenEnabled;},set:function(val){pipeline.sharpenEnabled=val;}});Object.defineProperty($this.pipeline.sharpening,'edge',{get:function(){return pipeline.sharpen.edgeAmount;},set:function(val){pipeline.sharpen.edgeAmount=val;}});Object.defineProperty($this.pipeline.sharpening,'color',{get:function(){return pipeline.sharpen.colorAmount;},set:function(val){pipeline.sharpen.colorAmount=val;}});$this.pipeline.depthOfField={};Object.defineProperty($this.pipeline.depthOfField,'enabled',{get:function(){return pipeline.depthOfFieldEnabled;},set:function(val){pipeline.depthOfFieldEnabled=val;}});Object.defineProperty($this.pipeline.depthOfField,'strength',{get:function(){return pipeline.depthOfFieldBlurLevel;},set:function(val){pipeline.depthOfFieldBlurLevel=val;}});Object.defineProperty($this.pipeline.depthOfField,'focusDistance',{get:function(){return pipeline.depthOfField.focusDistance;},set:function(val){pipeline.depthOfField.focusDistance=val;}});Object.defineProperty($this.pipeline.depthOfField,'focalLength',{get:function(){return pipeline.depthOfField.focalLength;},set:function(val){pipeline.depthOfField.focalLength=val;}});Object.defineProperty($this.pipeline.depthOfField,'fStop',{get:function(){return pipeline.depthOfField.fStop;},set:function(val){pipeline.depthOfField.fStop=val;}});$this.pipeline.bloom={};Object.defineProperty($this.pipeline.bloom,'enabled',{get:function(){return pipeline.bloomEnabled;},set:function(val){pipeline.bloomEnabled=val;}});Object.defineProperty($this.pipeline.bloom,'kernel',{get:function(){return pipeline.bloomKernel;},set:function(val){pipeline.bloomKernel=val;}});Object.defineProperty($this.pipeline.bloom,'weight',{get:function(){return pipeline.bloomWeight;},set:function(val){pipeline.bloomWeight=val;}});Object.defineProperty($this.pipeline.bloom,'threshold',{get:function(){return pipeline.bloomThreshold;},set:function(val){pipeline.bloomThreshold=val;}});Object.defineProperty($this.pipeline.bloom,'scale',{get:function(){return pipeline.bloomScale;},set:function(val){pipeline.bloomScale=val;}});$this.pipeline.colorMap={};Object.defineProperty($this.pipeline.colorMap,'enabled',{get:function(){return pipeline.imageProcessing.colorCurvesEnabled;},set:function(val){pipeline.imageProcessing.colorCurvesEnabled=val;}});Object.defineProperty($this.pipeline.colorMap,'globalHue',{get:function(){return curve.globalHue;},set:function(val){curve.globalHue=val;}});Object.defineProperty($this.pipeline.colorMap,'globalDensity',{get:function(){return curve.globalDensity;},set:function(val){curve.globalDensity=val;}});Object.defineProperty($this.pipeline.colorMap,'globalSaturation',{get:function(){return curve.globalSaturation;},set:function(val){curve.globalSaturation=val;}});Object.defineProperty($this.pipeline.colorMap,'highlightsHue',{get:function(){return curve.highlightsHue;},set:function(val){curve.highlightsHue=val;}});Object.defineProperty($this.pipeline.colorMap,'highlightsDensity',{get:function(){return curve.highlightsDensity;},set:function(val){curve.highlightsDensity=val;}});Object.defineProperty($this.pipeline.colorMap,'highlightsSaturation',{get:function(){return curve.highlightsSaturation;},set:function(val){curve.highlightsSaturation=val;}});Object.defineProperty($this.pipeline.colorMap,'shadowsHue',{get:function(){return curve.shadowsHue;},set:function(val){curve.shadowsHue=val;}});Object.defineProperty($this.pipeline.colorMap,'shadowsDensity',{get:function(){return curve.shadowsDensity;},set:function(val){curve.shadowsDensity=val;}});Object.defineProperty($this.pipeline.colorMap,'shadowsSaturation',{get:function(){return curve.shadowsSaturation;},set:function(val){curve.shadowsSaturation=val;}});$this.pipeline.toneMap={};Object.defineProperty($this.pipeline.toneMap,'enabled',{get:function(){return pipeline.imageProcessing.toneMappingEnabled;},set:function(val){pipeline.imageProcessing.toneMappingEnabled=val;}});Object.defineProperty($this.pipeline.toneMap,'contrast',{get:function(){return pipeline.imageProcessing.contrast;},set:function(val){pipeline.imageProcessing.contrast=val;}});Object.defineProperty($this.pipeline.toneMap,'exposure',{get:function(){return pipeline.imageProcessing.exposure;},set:function(val){pipeline.imageProcessing.exposure=val;}});$this.pipeline.vignette={};Object.defineProperty($this.pipeline.vignette,'enabled',{get:function(){return pipeline.imageProcessing.vignetteEnabled;},set:function(val){pipeline.imageProcessing.vignetteEnabled=val;}});Object.defineProperty($this.pipeline.vignette,'color',{get:function(){return pipeline.imageProcessing.vignetteColor;},set:function(val){pipeline.imageProcessing.vignetteColor=val;}});Object.defineProperty($this.pipeline.vignette,'weight',{get:function(){return pipeline.imageProcessing.vignetteWeight;},set:function(val){pipeline.imageProcessing.vignetteWeight=val;}});$this.pipeline.filmGrain={};Object.defineProperty($this.pipeline.filmGrain,'enabled',{get:function(){return pipeline.grainEnabled;},set:function(val){pipeline.grainEnabled=val;}});Object.defineProperty($this.pipeline.filmGrain,'intensity',{get:function(){return pipeline.grain.intensity;},set:function(val){pipeline.grain.intensity=val;}});Object.defineProperty($this.pipeline.filmGrain,'animated',{get:function(){return pipeline.grain.animated;},set:function(val){pipeline.grain.animated=val;}});$this.pipeline.MSAA=config.MSAA;$this.environment=new OCS.Environment(private.name);$this.environment.bindComponent(new OCS.Component("position",{x:new Prop(0),y:new Prop(0),z:new Prop(0)}));$this.environment.bindComponent(new OCS.Component("scale",{x:new Prop(1),y:new Prop(1),z:new Prop(1)}));$this.environment.bindComponent(new OCS.Component("rotation",{x:new Prop(0),y:new Prop(0),z:new Prop(0)}));let renderTarget=new OCS.Component("renderTarget",new Prop(null));;$this.environment.bindComponent(renderTarget);$this.environment.createQuery('position',all('position','renderTarget'));let position=$this.environment.createSystem('position','position',(entity)=>{entity.renderTarget.position.x=entity.position.x;entity.renderTarget.position.z=entity.position.y;entity.renderTarget.position.y=entity.position.z;});;$this.environment.createQuery('scale',all('scale','renderTarget'));let scale=$this.environment.createSystem('scale','scale',(entity)=>{entity.renderTarget.scaling.x=entity.scale.x;entity.renderTarget.scaling.z=entity.scale.y;entity.renderTarget.scaling.y=entity.scale.z;});;Math.Tau=Math.PI*2;$this.environment.createQuery('rotation',all('rotation','renderTarget'));let rotation=$this.environment.createSystem('rotation','rotation',(entity)=>{entity.rotation.z%=Math.Tau;entity.rotation.x%=Math.Tau;entity.rotation.y%=Math.Tau;entity.renderTarget.rotationQuaternion=BABYLON.Quaternion.RotationYawPitchRoll(entity.rotation.z,entity.rotation.x,entity.rotation.y);});;$this.add={};$this.add.box=function(name,config){if(config==null){config={};};if(config.position==null){config.position={x:0,y:0,z:0};};if(config.scale==null){config.scale={x:1,y:1,z:1};};if(config.rotation==null){config.rotation={x:0,y:0,z:0};};let mesh=new BABYLON.Mesh.CreateBox(name,1,private.scene);;mesh.position.set(config.position.x,config.position.z,config.position.y);mesh.scaling.set(config.scale.x,config.scale.z,config.scale.y);mesh.rotationQuaternion=BABYLON.Quaternion.RotationYawPitchRoll(config.rotation.z,config.rotation.x,config.rotation.y);private.shadowGenerator.getShadowMap().renderList.push(mesh);mesh.receiveShadows=true;let entity=self.environment.createEntity(name);;entity.bindComponent("renderTarget",mesh);return entity;};private.fpsTimer=process.hrtime();private.fpsMax=Infinity*-1;Object.defineProperty(this, "fpsMax", {get: ()=>{return private.fpsMax;}});private.fpsMin=Infinity;Object.defineProperty(this, "fpsMin", {get: ()=>{return private.fpsMin;}});private.fpsBoundsWaitCounter=120;private.fps=0;Object.defineProperty(this, "fps", {get: ()=>{return private.fps;}});private.frameTime=0;Object.defineProperty(this, "frameTime", {get: ()=>{return private.frameTime;}});private.tickindex=0;private.ticksum=0;private.ticklist=[1000];private.ticklist_size=0;private.fpsAvg=0;Object.defineProperty(this, "fpsAvg", {get: ()=>{return private.fpsAvg;}});let calc_average_tick=function(newtick){if(private.ticklist_size==1000){private.ticksum-=private.ticklist[private.tickindex];}else{private.ticklist_size+=1;};private.ticksum+=newtick;private.ticklist[private.tickindex]=newtick;private.tickindex+=1;if(private.tickindex==1000){private.tickindex=0;};if(private.ticklist_size==1000){return Math.floor(private.ticksum/1000);}else{return Math.floor(private.ticksum/private.ticklist_size);};};let calc_performance=function(){let diff=process.hrtime(private.fpsTimer);;private.frameTime=diff[0]*1000000000+diff[1];private.fps=Math.floor(1000000000/private.frameTime);private.fpsAvg=calc_average_tick(private.fps);if(private.fpsBoundsWaitCounter==0){if(private.fps>private.fpsMax){private.fpsMax=private.fps};if(private.fps<private.fpsMin){private.fpsMin=private.fps};}else{private.fpsBoundsWaitCounter-=1;};private.fpsTimer=process.hrtime();};let polling_rate=1/config.poll*1000;$this.animationScaling=function(value){if(private.fps!=0){return value*polling_rate/private.fps;}else{return 0;};};config.create($this);private.update=new time.AdvancedInterval(config.poll,()=>{config.update($this);});private.update.start();private.engine.runRenderLoop(()=>{calc_performance();config.render($this);position.run();scale.run();rotation.run();private.scene.render();});$this.getEngine=function(){return private.engine;};};Engine.$map=new Map();Engine.get=function(id){return Engine.$map.get(id);};Engine.has=function(id){return Engine.$map.has(id);};Engine.forEach=function(cb){Engine.$map.forEach(cb);};Engine.delete=function(cb){Engine.$map.delete(cb);};plugin.Engine=Engine;return plugin;})};