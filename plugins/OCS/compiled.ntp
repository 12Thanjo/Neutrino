module.exports=function($pending_plugins,$get_plugin){$pending_plugins.set('OCS',()=>{let plugin={metadata:{"name":"OCS","version":"0.1.0","description":"ECS architecture thats feature rich and incredibly fast","main":"index.nt","author":"12Thanjo","dependancies":["multithread"]}};let multithread=$get_plugin('multithread');let OCS=function(){let all=function(...conditionals){return {test:(entity)=>{let pass=true;for(var[i,comp]of conditionals.entries()){if(typeof comp==="string"){if(entity[comp]==null){pass=false;break;};}else{if(entity[comp.id]==null){pass=false;break;};};};return pass;}};};let none=function(...conditionals){return {test:(entity)=>{let pass=true;for(var[i,comp]of conditionals.entries()){if(typeof comp==="string"){if(entity[comp]!=null){pass=false;break;};}else{if(entity[comp.id]!=null){pass=false;break;};};};return pass;}};};let some=function(...conditionals){return {test:(entity)=>{let pass=false;for(var[i,comp]of conditionals.entries()){if(typeof comp==="string"){if(entity[comp]!=null){pass=true;break;};}else{if(entity[comp.id]!=null){pass=true;break;};};};return pass;}};};let Prop=function(auto){let $this=this;let private={};this.$op={};Prop.$map.set(auto,this);$this.auto=auto;};Prop.$map=new Map();Prop.get=function(id){return Prop.$map.get(id);};Prop.has=function(id){return Prop.$map.has(id);};Prop.forEach=function(cb){Prop.$map.forEach(cb);};Prop.delete=function(cb){Prop.$map.delete(cb);};let Component=function(id,builder){let $this=this;let private={};this.$op={};Component.$map.set(id,this);$this.id=id;$this.builder=builder;};Component.$map=new Map();Component.get=function(id){return Component.$map.get(id);};Component.has=function(id){return Component.$map.has(id);};Component.forEach=function(cb){Component.$map.forEach(cb);};Component.delete=function(cb){Component.$map.delete(cb);};let Environment=function(id){let $this=this;let private={};this.$op={};Environment.$map.set(id,this);private.id=id;private.entity_id=0;private.entity_lookup=new Map();private.removed=new Set();private.entities=[];let env_priv=private;let Entity=function(id,name){let $this=this;let private={};this.$op={};env_priv.entities[id]=$this;private.id=id;Object.defineProperty(this, "id", {get: ()=>{return private.id;}});private.name=name;Object.defineProperty(this, "name", {get: ()=>{return private.name;}});if(name!=null){env_priv.entity_lookup.set(private.name,$this);$this.destroy=function(){Query.forEach((query)=>{query.remove($this);});env_priv.entity_lookup.delete(private.name);env_priv.removed.add(private.id);env_priv.entities[private.id]=null;};}else{$this.destroy=function(){Query.forEach((query)=>{query.remove($this);});env_priv.removed.add(private.id);env_priv.entities[private.id]=null;};};$this.bindComponent=function(component,...params){if(component instanceof Component||component instanceof EnvComponent){component=component.id;};if(EnvComponent.has(component)==false){throw ReferenceError("Environment ("+(env_priv.id)+") does not have component ("+(component)+")");};let component_target=EnvComponent.get(component);;if(component_target.builder instanceof Prop){if(params[0]==null){params[0]=component_target.builder.auto;};$this[component]=params[0];}else{let builder_obj=Object.assign({},component_target.builder);;let i=0;let create_component_props=function(builder,depth_arr){if(builder instanceof Prop){if(params[i]==null){params[i]=builder.auto;};let target=builder_obj;for(var j=0;j<depth_arr.length-1;j++){target=target[depth_arr[j]];};target[depth_arr[depth_arr.length-1]]=params[i];i+=1;}else{for(let key in builder){let value=builder[key];create_component_props(value,[...depth_arr,key]);};};};create_component_props(builder_obj,[]);$this[component]=builder_obj;};Query.forEach((query)=>{query.audit($this);});return $this;};};let EnvComponent=function(id,builder){let $this=this;let private={};this.$op={};EnvComponent.$map.set(id,this);private.id=id;Object.defineProperty(this, "id", {get: ()=>{return private.id;}});$this.builder=builder;};EnvComponent.$map=new Map();EnvComponent.get=function(id){return EnvComponent.$map.get(id);};EnvComponent.has=function(id){return EnvComponent.$map.has(id);};EnvComponent.forEach=function(cb){EnvComponent.$map.forEach(cb);};EnvComponent.delete=function(cb){EnvComponent.$map.delete(cb);};let Query=function(id,conditionals){let $this=this;let private={};this.$op={};Query.$map.set(id,this);$this.entities=new Set();private.conditionals=conditionals;$this.audit=function(entity){let pass=true;for(var[i,conditional]of private.conditionals.entries()){if(conditional.test(entity)==false){pass=false;break;};};if(pass){$this.entities.add(entity.id);}else{$this.entities.delete(entity.id);};};$this.remove=function(entity){$this.entities.delete(entity.id);};for(var[i,entity]of env_priv.entities.entries()){if(entity!=null){$this.audit(entity);};};$this.forEach=function(event){for(var[i,id]of $this.entities.entries()){event(env_priv.entities[id],i);};};};Query.$map=new Map();Query.get=function(id){return Query.$map.get(id);};Query.has=function(id){return Query.$map.has(id);};Query.forEach=function(cb){Query.$map.forEach(cb);};Query.delete=function(cb){Query.$map.delete(cb);};let System=function(id,query,event){let $this=this;let private={};this.$op={};System.$map.set(id,this);private.query=Query.get(query);private.event=event;$this.run=function(){private.query.forEach((entity,i)=>{private.event(entity,i);});};$this.setupCluster=function(threads){event_str="evnt=($data)=>{$data.data=("+(event.toString())+")($data.data, $data.i);return $data;};";let evnt=null;eval(event_str);private.cluster=new multithread.cluster.forEach(threads,evnt);};$this.runThreaded=function(components,callback){let array=[];private.query.forEach((entity)=>{let obj={};for(var[i,component]of components.entries()){obj[component]=entity[component];};array.push(obj);});private.cluster.run(array,(i,data)=>{private.query.forEach((entity)=>{for(var[j,component]of components.entries()){entity[component]=data[component];};});},callback);};$this.runThreadedSafe=function(components,callback){let array=[];let entities=[];private.query.forEach((entity)=>{let obj={};for(var[i,component]of components.entries()){obj[component]=entity[component];entities.push(i);};array.push(obj);entities.push(entity);});private.cluster.run(array,(i,data)=>{for(var[j,entity]of entities.entries()){for(var[k,component]of components.entries()){entity[component]=data[component];};};},callback);};};System.$map=new Map();System.get=function(id){return System.$map.get(id);};System.has=function(id){return System.$map.has(id);};System.forEach=function(cb){System.$map.forEach(cb);};System.delete=function(cb){System.$map.delete(cb);};$this.bindComponent=function(component){if(EnvComponent.has(component.id)){throw Error("Environment ("+(private.id)+") already has component ("+(component.id)+")");};return new EnvComponent(component.id,component.builder);};$this.getComponent=function(id){return EnvComponent.get(id);};$this.createEntity=function(name){let new_entity=null;if(private.removed.size==0){new_entity=new Entity(private.entity_id,name);private.entity_id+=1;}else{let entity_id=private.removed.values().next().value;private.removed.delete(entity_id);new_entity=new Entity(entity_id,name);};return new_entity;};$this.getEntity=function(name){return private.entity_lookup.get(name);};$this.createQuery=function(id,...conditionals){new Query(id,conditionals);};$this.deleteQuery=function(id){Query.delete(id);};$this.createSystem=function(id,query,event){return new System(id,query,event);};$this.getSystem=function(id){return System.get(id);};$this.deleteSystem=function(id){System.delete(id);};};Environment.$map=new Map();Environment.get=function(id){return Environment.$map.get(id);};Environment.has=function(id){return Environment.$map.has(id);};Environment.forEach=function(cb){Environment.$map.forEach(cb);};Environment.delete=function(cb){Environment.$map.delete(cb);};let EventLoop=function(name){let $this=this;let private={};this.$op={};EventLoop.$map.set(name,this);private.name=name;Object.defineProperty(this, "name", {get: ()=>{return private.name;}});private.i=0;private.queue=[];$this.add=function(event){private.queue.push(event);};$this.next=function(){private.i+=1;try{private.queue[private.i]($this.next);}catch{};};$this.start=function(){private.i=-1;$this.next();};};EventLoop.$map=new Map();EventLoop.get=function(id){return EventLoop.$map.get(id);};EventLoop.has=function(id){return EventLoop.$map.has(id);};EventLoop.forEach=function(cb){EventLoop.$map.forEach(cb);};EventLoop.delete=function(cb){EventLoop.$map.delete(cb);};return {Environment:Environment,Component:Component,Prop:Prop,all:all,none:none,some:some,EventLoop:EventLoop};};plugin=new OCS();return plugin;})};